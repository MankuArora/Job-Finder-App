<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Finder - Find Jobs Near You</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .job-source {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .source-naukri {
            background-color: #f0f9ff;
            color: #3b82f6;
        }
        
        .source-internshala {
            background-color: #ecfdf5;
            color: #10b981;
        }
        
        .source-linkedin {
            background-color: #eef2ff;
            color: #4f46e5;
        }
        
        .source-indeed {
            background-color: #fffbeb;
            color: #f59e0b;
        }
        
        .job-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <h1 class="text-2xl font-bold text-blue-600 mr-2">JobNearby</h1>
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded">Beta</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="currentLocation" class="text-gray-600 text-sm">
                        <i class="fas fa-map-marker-alt text-red-500 mr-2"></i> Detecting your location...
                    </div>
                    <button id="locateBtn" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-medium">
                        <i class="fas fa-location-arrow mr-2"></i> Get My Location
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border p-5 sticky top-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Filters</h2>
                    
                    <div class="mb-5">
                        <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Search Jobs</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input id="searchInput" type="text" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Job title, skills, or company">
                        </div>
                    </div>
                    
                    <div class="mb-5">
                        <label for="radiusSelect" class="block text-sm font-medium text-gray-700 mb-1">Distance</label>
                        <select id="radiusSelect" class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                            <option value="5">5 km</option>
                            <option value="10" selected>10 km</option>
                            <option value="20">20 km</option>
                            <option value="50">50 km</option>
                        </select>
                    </div>
                    
                    <div class="mb-5">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Job Type</h3>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input id="fulltime" name="job-type" value="fulltime" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="fulltime" class="ml-2 block text-sm text-gray-700">Full-time</label>
                            </div>
                            <div class="flex items-center">
                                <input id="parttime" name="job-type" value="parttime" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="parttime" class="ml-2 block text-sm text-gray-700">Part-time</label>
                            </div>
                            <div class="flex items-center">
                                <input id="contract" name="job-type" value="contract" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="contract" class="ml-2 block text-sm text-gray-700">Contract</label>
                            </div>
                            <div class="flex items-center">
                                <input id="internship" name="job-type" value="internship" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="internship" class="ml-2 block text-sm text-gray-700">Internship</label>
                            </div>
                            <div class="flex items-center">
                                <input id="remote" name="job-type" value="remote" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="remote" class="ml-2 block text-sm text-gray-700">Remote</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-5">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Experience Level</h3>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input id="entrylevel" name="experience" value="entrylevel" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="entrylevel" class="ml-2 block text-sm text-gray-700">Entry Level</label>
                            </div>
                            <div class="flex items-center">
                                <input id="midlevel" name="experience" value="midlevel" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="midlevel" class="ml-2 block text-sm text-gray-700">Mid Level</label>
                            </div>
                            <div class="flex items-center">
                                <input id="seniorlevel" name="experience" value="seniorlevel" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="seniorlevel" class="ml-2 block text-sm text-gray-700">Senior Level</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-5">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Job Source</h3>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input id="naukri" name="source" value="naukri" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="naukri" class="ml-2 block text-sm text-gray-700">Naukri</label>
                            </div>
                            <div class="flex items-center">
                                <input id="internshala" name="source" value="internshala" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="internshala" class="ml-2 block text-sm text-gray-700">Internshala</label>
                            </div>
                            <div class="flex items-center">
                                <input id="linkedin" name="source" value="linkedin" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="linkedin" class="ml-2 block text-sm text-gray-700">LinkedIn</label>
                            </div>
                            <div class="flex items-center">
                                <input id="indeed" name="source" value="indeed" type="checkbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="indeed" class="ml-2 block text-sm text-gray-700">Indeed</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="applyFiltersBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">Apply</button>
                        <button id="resetFiltersBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded">Reset</button>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-3">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Nearby Jobs</h2>
                        <p class="text-gray-500 text-sm">Last updated: <span id="lastUpdated">Now</span></p>
                        <p id="locationStatus" class="text-sm text-blue-600 mt-1">Waiting for your location...</p>
                    </div>
                    <div class="flex mt-3 md:mt-0 job-actions" id="controlsContainer">
                        <div class="mr-2">
                            <select id="sortSelect" class="block w-full pl-3 pr-10 py-2 text-sm border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                <option value="distance">Distance</option>
                                <option value="relevance">Relevance</option>
                                <option value="date">Date</option>
                                <option value="salary">Salary</option>
                            </select>
                        </div>
                        <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm border mb-6">
                    <div id="map" class="w-full h-64 md:h-80 rounded-t-lg overflow-hidden"></div>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Job Sources</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-medium text-gray-500">Naukri</span>
                                <span class="text-xs font-medium text-gray-900" id="naukriCount">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="naukriBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-medium text-gray-500">Internshala</span>
                                <span class="text-xs font-medium text-gray-900" id="internshalaCount">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="internshalaBar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-medium text-gray-500">LinkedIn</span>
                                <span class="text-xs font-medium text-gray-900" id="linkedinCount">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="linkedinBar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-medium text-gray-500">Indeed</span>
                                <span class="text-xs font-medium text-gray-900" id="indeedCount">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="indeedBar" class="bg-yellow-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="loadingJobs" class="flex justify-center items-center py-8 hidden">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"></div>
                    <span class="ml-3 text-gray-600">Finding jobs near you...</span>
                </div>
                
                <div id="noJobsFound" class="bg-white rounded-lg shadow-sm border p-8 text-center hidden">
                    <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">No jobs found</h3>
                    <p class="text-gray-500">Try expanding your search radius or changing your filters</p>
                </div>
                
                <div id="jobsContainer" class="space-y-4 hidden"></div>
                
                <div class="text-center py-6 hidden" id="loadMoreBtn">
                    <button class="bg-white hover:bg-gray-50 text-blue-600 font-medium py-3 px-6 rounded-lg border shadow-sm">
                        Load More Jobs
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="jobModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 id="modalJobTitle" class="text-xl font-bold text-gray-900"></h2>
                        <p id="modalCompany" class="text-gray-600 mt-1"></p>
                    </div>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="flex flex-wrap items-center mt-4 text-sm text-gray-500">
                    <div class="flex items-center mr-4 mb-2">
                        <i class="fas fa-map-marker-alt mr-1 text-red-500"></i>
                        <span id="modalLocation"></span>
                    </div>
                    <div class="flex items-center mr-4 mb-2">
                        <i class="fas fa-money-bill-wave mr-1 text-green-500"></i>
                        <span id="modalSalary"></span>
                    </div>
                    <div class="flex items-center mb-2">
                        <i class="fas fa-briefcase mr-1 text-blue-500"></i>
                        <span id="modalJobType"></span>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-sm font-medium text-gray-900 mb-2">Job Description</h3>
                    <p id="modalDescription" class="text-gray-700 text-sm"></p>
                </div>
                
                <div class="mt-4">
                    <h3 class="text-sm font-medium text-gray-900 mb-2">Requirements</h3>
                    <ul id="modalRequirements" class="list-disc list-inside text-sm text-gray-700 space-y-1"></ul>
                </div>
                
                <div class="mt-4">
                    <h3 class="text-sm font-medium text-gray-900 mb-2">Skills</h3>
                    <div id="modalSkills" class="flex flex-wrap gap-2"></div>
                </div>
                
                <div class="flex items-center justify-between mt-6">
                    <div class="flex items-center">
                        <span id="modalSource" class="px-3 py-1 rounded text-xs font-medium"></span>
                        <span id="modalPosted" class="text-xs text-gray-500 ml-2"></span>
                    </div>
                    <div class="modal-actions">
                        <a id="applyJobBtn" href="#" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg inline-flex items-center">
                            <i class="fas fa-external-link-alt mr-2"></i> Apply Now
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // API key for Geoapify (for reverse geocoding address display)
    const GEOAPIFY_API_KEY = 'bd0425512fd94b299640166f4ae66fd2';
    let map, marker; // These are placeholders if you integrate a real map later
    let currentLat, currentLng;
    let jobs = [];
    let currentPage = 1;
    let isLoading = false;
    let totalJobs = 0;
    let lastUpdate = new Date();

    // Backend API URL
    // Your backend will make the calls to SerpApi (or other job sources)
    const BACKEND_API = 'http://localhost:5000/api'; 

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners
        document.getElementById('locateBtn').addEventListener('click', getUserLocation);
        document.getElementById('refreshBtn').addEventListener('click', refreshJobs);
        // document.getElementById('loadMoreBtn').addEventListener('click', loadMoreJobs); // Uncomment if you implement pagination
        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
        document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
        document.getElementById('searchInput').addEventListener('input', debounce(searchJobs, 500));
        document.getElementById('sortSelect').addEventListener('change', sortJobs);
        document.getElementById('closeModal').addEventListener('click', closeJobModal);
        
        // Initialize map with a default location (will be updated)
        // This 'initMap' function will only display a placeholder for now.
        // For a real map, you'd integrate Google Maps JS API or Geoapify Maps API here.
        initMap(40.7128, -74.0060); // Default to NYC for visual placeholder

        // Initial fetch: Try to get user location or use saved one
        loadInitialData();

        // Update last updated text
        document.getElementById('lastUpdated').textContent = formatDate(new Date());
        
        // --- Optional (if you enable these features later) ---
        // Initialize the export button once jobs are loaded
        // const observer = new MutationObserver((mutations) => {
        //     mutations.forEach((mutation) => {
        //         if (mutation.target.id === 'jobsContainer' && 
        //             mutation.type === 'childList' && 
        //             mutation.addedNodes.length > 0) {
        //             createExportButton();
        //             observer.disconnect();
        //         }
        //     });
        // });
        // observer.observe(document.getElementById('jobsContainer'), { childList: true });
        // createFavoritesButton();
        // initRealTimeUpdates(); // If you have real-time updates
        // ----------------------------------------------------

        // Check URL for job ID parameter (for deep linking)
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('jobId');
        if (jobId) {
            // This part might need adjustment based on how your backend retrieves single jobs
            const checkForJobs = setInterval(() => {
                if (jobs.length > 0) {
                    clearInterval(checkForJobs);
                    const job = jobs.find(j => j.id === jobId);
                    if (job) {
                        showJobDetails(job);
                    }
                }
            }, 500);
        }
    });

    async function loadInitialData() {
        // Check for saved location in localStorage
        const savedLat = localStorage.getItem('jobFinder_lat');
        const savedLng = localStorage.getItem('jobFinder_lng');
        
        if (savedLat && savedLng) {
            // Use saved location
            currentLat = parseFloat(savedLat);
            currentLng = parseFloat(savedLng);
            await updateLocationDisplay(currentLat, currentLng); // Await for address lookup
            initMap(currentLat, currentLng);
            fetchNearbyJobs(currentLat, currentLng);
            document.getElementById('locateBtn').innerHTML = '<i class="fas fa-location-arrow mr-2"></i> Update My Location';
        } else {
            // Try to get user's location automatically
            getUserLocation();
        }
    }

    // Utility function for debouncing search
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                func.apply(context, args);
            }, wait);
        };
    }

    // Placeholder for map initialization (you'd replace this with a real map library)
    function initMap(lat, lng) {
        const mapDiv = document.getElementById('map');
        mapDiv.innerHTML = `
            <div class="w-full h-full flex items-center justify-center bg-gray-100 rounded">
                <div class="text-center">
                    <p class="text-gray-700 font-medium">Your Current Location</p>
                    <p class="text-gray-500 text-sm mt-2">Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</p>
                    <p class="text-gray-500 text-sm mt-1">This is a placeholder for a map.</p>
                    <p class="text-gray-500 text-sm mt-1">You can integrate Google Maps JS API or Geoapify Maps API here.</p>
                </div>
            </div>
        `;
        // Update current coordinates for global access
        currentLat = lat;
        currentLng = lng;
    }

    // Get user's location using browser Geolocation API
    function getUserLocation() {
        const locationBtn = document.getElementById('locateBtn');
        const statusEl = document.getElementById('locationStatus');
        
        locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Locating...';
        statusEl.textContent = 'Requesting your location...';
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    updateLocationDisplay(lat, lng); // Update display with address
                    initMap(lat, lng); // Update map placeholder
                    fetchNearbyJobs(lat, lng); // Fetch jobs
                    saveLocationToStorage(lat, lng); // Save for next visit
                    
                    locationBtn.innerHTML = '<i class="fas fa-location-arrow mr-2"></i> Location Found';
                    statusEl.textContent = 'Your location has been detected';
                    
                    // After 2 seconds, restore the button text
                    setTimeout(() => {
                        locationBtn.innerHTML = '<i class="fas fa-location-arrow mr-2"></i> Update My Location';
                    }, 2000);
                },
                (error) => {
                    locationBtn.innerHTML = '<i class="fas fa-location-arrow mr-2"></i> Get My Location';
                    handleLocationError(error); // Call error handler
                    statusEl.textContent = 'Location access denied or unavailable.';
                    console.error("Geolocation Error:", error);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 } // Geolocation options
            );
        } else {
            locationBtn.innerHTML = '<i class="fas fa-location-arrow mr-2"></i> Get My Location';
            statusEl.textContent = 'Geolocation is not supported by this browser.';
            console.error("Geolocation is not supported by this browser.");
            // Optionally, fetch jobs for a default location if geolocation is not supported
            // fetchNearbyJobs(40.7128, -74.0060); // e.g., New York
        }
    }

    // Handle geolocation errors
    function handleLocationError(error) {
        const statusEl = document.getElementById('locationStatus');
        switch(error.code) {
            case error.PERMISSION_DENIED:
                statusEl.textContent = "Location access denied. Please allow location in browser settings.";
                break;
            case error.POSITION_UNAVAILABLE:
                statusEl.textContent = "Location information is unavailable.";
                break;
            case error.TIMEOUT:
                statusEl.textContent = "The request to get user location timed out.";
                break;
            case error.UNKNOWN_ERROR:
                statusEl.textContent = "An unknown error occurred.";
                break;
        }
        // Optionally, fetch jobs for a default location
        fetchNearbyJobs(40.7128, -74.0060); // Default to NYC if error
    }

    // Reverse Geocoding to get human-readable address
    async function updateLocationDisplay(lat, lng) {
        const locationEl = document.getElementById('currentLocation');
        locationEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Getting address...';
        
        try {
            const response = await fetch(`https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lng}&apiKey=${GEOAPIFY_API_KEY}`);
            const data = await response.json();

            if (data.features && data.features.length > 0) {
                const address = data.features[0].properties.formatted;
                locationEl.innerHTML = `<i class="fas fa-map-marker-alt text-red-500 mr-2"></i> ${address}`;
            } else {
                locationEl.innerHTML = `<i class="fas fa-map-marker-alt text-red-500 mr-2"></i> Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
            }
        } catch (error) {
            console.error("Error fetching address:", error);
            locationEl.innerHTML = `<i class="fas fa-map-marker-alt text-red-500 mr-2"></i> Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)} (Address lookup failed)`;
        }
        
        // Store current coordinates
        currentLat = lat;
        currentLng = lng;
    }

    // Save location to localStorage
    function saveLocationToStorage(lat, lng) {
        localStorage.setItem('jobFinder_lat', lat);
        localStorage.setItem('jobFinder_lng', lng);
    }

    // Fetch nearby jobs from your backend API
    async function fetchNearbyJobs(lat, lng) {
        const radius = document.getElementById('radiusSelect').value;
        const searchInput = document.getElementById('searchInput').value;
        const jobTypes = Array.from(document.querySelectorAll('input[name="job-type"]:checked')).map(cb => cb.value);
        const experienceLevels = Array.from(document.querySelectorAll('input[name="experience"]:checked')).map(cb => cb.value);
        const jobSources = Array.from(document.querySelectorAll('input[name="source"]:checked')).map(cb => cb.value);
        const sortBy = document.getElementById('sortSelect').value;

        const loadingEl = document.getElementById('loadingJobs');
        const jobsContainer = document.getElementById('jobsContainer');
        const noJobsEl = document.getElementById('noJobsFound');
        const loadMoreBtnContainer = document.getElementById('loadMoreBtn'); // Container for the load more button
        
        // Show loading, hide others
        loadingEl.classList.remove('hidden');
        jobsContainer.classList.add('hidden');
        noJobsEl.classList.add('hidden');
        loadMoreBtnContainer.classList.add('hidden');
        
        isLoading = true;

        // Construct query parameters for your backend
        const queryParams = new URLSearchParams({
            lat: lat,
            lng: lng,
            radius: radius,
            q: searchInput, // Pass search query
            job_types: jobTypes.join(','),
            experience_levels: experienceLevels.join(','),
            job_sources: jobSources.join(','),
            sort_by: sortBy,
            page: currentPage,
            limit: 10 // Assuming a limit for pagination
        });

        try {
            const response = await fetch(`${BACKEND_API}/jobs?${queryParams.toString()}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            
            jobs = data.jobs || []; // Update global jobs array
            totalJobs = data.total_jobs || 0; // Assuming backend sends total_jobs

            displayJobs(jobs);
            updateSourceAnalytics(jobs);
            
            // Show/hide no jobs message
            if (jobs.length === 0) {
                noJobsEl.classList.remove('hidden');
                jobsContainer.classList.add('hidden'); // Ensure jobs container is hidden if no jobs
            } else {
                noJobsEl.classList.add('hidden');
                jobsContainer.classList.remove('hidden');
            }

            // Show/hide load more button (simple check, can be more complex with totalPages)
            if (jobs.length < totalJobs) {
                loadMoreBtnContainer.classList.remove('hidden');
            } else {
                loadMoreBtnContainer.classList.add('hidden');
            }

            document.getElementById('lastUpdated').textContent = formatDate(new Date());

        } catch (error) {
            console.error("Error fetching jobs:", error);
            jobsContainer.innerHTML = `<p class="text-red-600 text-center">Failed to load jobs. Please try again later.</p>`;
            noJobsEl.classList.add('hidden'); // Hide no jobs message on error
        } finally {
            loadingEl.classList.add('hidden');
            isLoading = false;
        }
    }

    // Function to calculate distance between two coordinates (Haversine formula)
    function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of Earth in kilometers

        const lat1_rad = toRadians(lat1);
        const lon1_rad = toRadians(lon1);
        const lat2_rad = toRadians(lat2);
        const lon2_rad = toRadians(lon2);

        const dlon = lon2_rad - lon1_rad;
        const dlat = lat2_rad - lat1_rad;

        const a = Math.sin(dlat / 2) * Math.sin(dlat / 2) +
                  Math.cos(lat1_rad) * Math.cos(lat2_rad) *
                  Math.sin(dlon / 2) * Math.sin(dlon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        const distance = R * c;
        return distance;
    }

    function toRadians(degrees) {
        return degrees * Math.PI / 180;
    }

    // Display jobs in the UI
    function displayJobs(jobsToDisplay) {
        const jobsContainer = document.getElementById('jobsContainer');
        jobsContainer.innerHTML = ''; // Clear previous jobs

        if (jobsToDisplay.length === 0) {
            document.getElementById('noJobsFound').classList.remove('hidden');
            return;
        }

        jobsToDisplay.forEach(job => {
            const distance = (currentLat && currentLng && job.location && job.location.lat && job.location.lng) 
                             ? haversine(currentLat, currentLng, job.location.lat, job.location.lng).toFixed(1) + ' km'
                             : 'N/A';

            const jobCard = document.createElement('div');
            jobCard.className = 'job-card bg-white rounded-lg shadow-sm border p-5 relative overflow-hidden';
            jobCard.innerHTML = `
                <span class="job-source source-${job.source.toLowerCase()}">${job.source}</span>
                <h3 class="text-lg font-semibold text-gray-800 mb-1">${job.title}</h3>
                <p class="text-gray-600 text-sm mb-2">${job.company_name}</p>
                <div class="flex flex-wrap items-center text-gray-500 text-xs mb-3">
                    <span class="flex items-center mr-3"><i class="fas fa-map-marker-alt mr-1 text-red-500"></i>${job.location.address || 'Location not specified'} (${distance})</span>
                    <span class="flex items-center mr-3"><i class="fas fa-money-bill-wave mr-1 text-green-500"></i>${job.salary || 'Not disclosed'}</span>
                    <span class="flex items-center"><i class="fas fa-briefcase mr-1 text-blue-500"></i>${job.job_type || 'N/A'}</span>
                </div>
                <p class="text-gray-700 text-sm line-clamp-3">${job.description || 'No description available.'}</p>
                <div class="flex flex-wrap gap-2 mt-3">
                    ${job.skills ? job.skills.map(skill => `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs">${skill}</span>`).join('') : ''}
                </div>
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                    <span class="text-xs text-gray-500">Posted: ${formatDate(new Date(job.posted_at))}</span>
                    <button class="apply-btn bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-medium" data-job-id="${job.id}">
                        View Details
                    </button>
                </div>
            `;
            jobCard.querySelector('.apply-btn').addEventListener('click', () => showJobDetails(job));
            jobsContainer.appendChild(jobCard);
        });
        document.getElementById('noJobsFound').classList.add('hidden'); // Hide "no jobs found" if jobs are displayed
    }

    // Refresh jobs based on current filters and location
    function refreshJobs() {
        if (currentLat && currentLng) {
            currentPage = 1; // Reset page number for fresh search
            fetchNearbyJobs(currentLat, currentLng);
        } else {
            alert('Please allow location access to refresh jobs.');
            getUserLocation(); // Prompt for location if not available
        }
    }

    // Apply filters
    function applyFilters() {
        if (currentLat && currentLng) {
            currentPage = 1; // Reset page when applying filters
            fetchNearbyJobs(currentLat, currentLng);
        } else {
            alert('Please allow location access to apply filters.');
            getUserLocation();
        }
    }

    // Reset filters
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('radiusSelect').value = '10'; // Default radius
        document.querySelectorAll('input[name="job-type"]').forEach(cb => cb.checked = true);
        document.querySelectorAll('input[name="experience"]').forEach(cb => cb.checked = true);
        document.querySelectorAll('input[name="source"]').forEach(cb => cb.checked = true);
        document.getElementById('sortSelect').value = 'distance';
        applyFilters(); // Apply reset filters
    }

    // Search jobs (debounced)
    function searchJobs() {
        if (currentLat && currentLng) {
            currentPage = 1; // Reset page when searching
            fetchNearbyJobs(currentLat, currentLng);
        }
    }

    // Sort jobs (client-side for now, can be server-side)
    function sortJobs() {
        const sortBy = document.getElementById('sortSelect').value;
        let sortedJobs = [...jobs]; // Create a copy to sort

        if (sortBy === 'distance' && currentLat && currentLng) {
            sortedJobs.sort((a, b) => {
                const distA = haversine(currentLat, currentLng, a.location.lat, a.location.lng);
                const distB = haversine(currentLat, currentLng, b.location.lat, b.location.lng);
                return distA - distB;
            });
        } else if (sortBy === 'date') {
            sortedJobs.sort((a, b) => new Date(b.posted_at) - new Date(a.posted_at));
        } else if (sortBy === 'salary') {
            // Sort by salary, assuming salary can be parsed as a number for comparison
            // This might need more robust parsing depending on salary formats (e.g., "50k-70k", "Negotiable")
            sortedJobs.sort((a, b) => (parseFloat(b.salary) || 0) - (parseFloat(a.salary) || 0));
        }
        // 'relevance' sorting would typically be handled by the backend search algorithm
        
        displayJobs(sortedJobs);
    }

    // Load more jobs (if pagination is implemented)
    function loadMoreJobs() {
        if (!isLoading && jobs.length < totalJobs) {
            currentPage++;
            fetchNearbyJobs(currentLat, currentLng); // Fetch more jobs
        }
    }

    // Show job details modal
    function showJobDetails(job) {
        const modal = document.getElementById('jobModal');
        document.getElementById('modalJobTitle').textContent = job.title;
        document.getElementById('modalCompany').textContent = job.company_name;
        document.getElementById('modalLocation').textContent = job.location.address || 'Location not specified';
        document.getElementById('modalSalary').textContent = job.salary || 'Not disclosed';
        document.getElementById('modalJobType').textContent = job.job_type || 'N/A';
        document.getElementById('modalDescription').textContent = job.description || 'No description available.';
        
        const requirementsList = document.getElementById('modalRequirements');
        requirementsList.innerHTML = '';
        if (job.requirements && job.requirements.length > 0) {
            job.requirements.forEach(req => {
                const li = document.createElement('li');
                li.textContent = req;
                requirementsList.appendChild(li);
            });
        } else {
            requirementsList.innerHTML = '<li>No specific requirements listed.</li>';
        }

        const skillsContainer = document.getElementById('modalSkills');
        skillsContainer.innerHTML = '';
        if (job.skills && job.skills.length > 0) {
            job.skills.forEach(skill => {
                const span = document.createElement('span');
                span.className = 'bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs';
                span.textContent = skill;
                skillsContainer.appendChild(span);
            });
        } else {
            skillsContainer.innerHTML = '<span class="text-gray-500 text-xs">No specific skills listed.</span>';
        }

        const modalSource = document.getElementById('modalSource');
        modalSource.textContent = job.source;
        modalSource.className = `px-3 py-1 rounded text-xs font-medium source-${job.source.toLowerCase()}`;
        document.getElementById('modalPosted').textContent = `Posted: ${formatDate(new Date(job.posted_at))}`;
        document.getElementById('applyJobBtn').href = job.url;

        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden'); // Prevent scrolling body when modal is open
    }

    // Close job details modal
    function closeJobModal() {
        document.getElementById('jobModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    // Format date for display
    function formatDate(date) {
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        
        if (seconds < 60) return `${seconds} seconds ago`;
        
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} minutes ago`;
        
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hours ago`;
        
        const days = Math.floor(hours / 24);
        if (days < 7) return `${days} days ago`;

        // If older than a week, show full date
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Update job source analytics bars
    function updateSourceAnalytics(jobsData) {
        const sourceCounts = {
            naukri: 0,
            internshala: 0,
            linkedin: 0,
            indeed: 0
        };

        jobsData.forEach(job => {
            const source = job.source.toLowerCase();
            if (sourceCounts.hasOwnProperty(source)) {
                sourceCounts[source]++;
            }
        });

        const totalAvailableJobs = Object.values(sourceCounts).reduce((sum, count) => sum + count, 0);

        Object.keys(sourceCounts).forEach(source => {
            const count = sourceCounts[source];
            const percentage = totalAvailableJobs > 0 ? (count / totalAvailableJobs) * 100 : 0;
            
            document.getElementById(`${source}Count`).textContent = count;
            document.getElementById(`${source}Bar`).style.width = `${percentage}%`;
        });
    }

    // --- Optional Feature Implementations (Placeholders) ---

    // function createExportButton() {
    //     // Add export to CSV/PDF functionality
    //     const controlsContainer = document.getElementById('controlsContainer');
    //     const exportBtn = document.createElement('button');
    //     exportBtn.id = 'exportBtn';
    //     exportBtn.className = 'bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded flex items-center ml-2';
    //     exportBtn.innerHTML = '<i class="fas fa-download mr-2"></i> Export Jobs';
    //     exportBtn.addEventListener('click', exportJobs);
    //     controlsContainer.appendChild(exportBtn);
    // }

    // function exportJobs() {
    //     // Logic to export current 'jobs' array to CSV or PDF
    //     console.log('Exporting jobs:', jobs);
    //     alert('Export functionality is a placeholder. Implement CSV/PDF export here.');
    // }

    // function createFavoritesButton() {
    //     // Add a favorites button or section
    //     // This would typically involve localStorage or a backend for persistence
    //     console.log('Favorites button placeholder.');
    // }

    // function initRealTimeUpdates() {
    //     // Placeholder for WebSocket or SSE for real-time job updates
    //     console.log('Real-time updates not implemented.');
    // }
    </script>
</body>
</html>